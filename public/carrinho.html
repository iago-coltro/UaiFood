<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAIfood - Finalizar Pedido</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #1A1A2E; color: white; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #FF6B35; text-align: center; margin-bottom: 30px; }
        
        /* Se√ß√µes */
        .section { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .section h3 { margin-bottom: 15px; color: #FF6B35; display: flex; justify-content: space-between; align-items: center; }
        
        /* Itens */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .cart-item:last-child { border-bottom: none; }
        .qty-controls button { background: #FF6B35; border: none; color: white; width: 25px; height: 25px; border-radius: 5px; cursor: pointer; }
        .qty-controls span { margin: 0 10px; }

        /* Endere√ßo */
        select { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; }
        .btn-add { background: transparent; border: 1px solid #FF6B35; color: #FF6B35; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        
        /* Pagamento */
        .payment-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .payment-option { cursor: pointer; }
        .payment-option input { display: none; }
        .payment-card { border: 1px solid rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center; transition: 0.3s; }
        .payment-card:hover { background: rgba(255,255,255,0.1); }
        .payment-option input:checked + .payment-card { border-color: #FF6B35; background: rgba(255, 107, 53, 0.1); color: #FF6B35; font-weight: bold; }

        /* Total e Bot√£o */
        .total-bar { font-size: 1.5rem; font-weight: bold; text-align: right; margin: 20px 0; }
        .btn-checkout { width: 100%; padding: 18px; background: #22C55E; border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }
        .btn-checkout:hover { background: #1ca84c; transform: translateY(-2px); }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #aaa; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõí Finalizar Pedido</h1>

    <div class="section">
        <h3>Itens do Pedido</h3>
        <div id="cart-items"></div>
    </div>

    <div class="section">
        <h3>
            Entrega
            <button class="btn-add" onclick="window.location.href='/endereco'">+ Novo Endere√ßo</button>
        </h3>
        <select id="endereco-select">
            <option value="" disabled selected>Carregando endere√ßos...</option>
        </select>
    </div>

    <div class="section">
        <h3>Forma de Pagamento</h3>
        <div class="payment-options">
            <label class="payment-option">
                <input type="radio" name="pagamento" value="PIX">
                <div class="payment-card">üí† PIX</div>
            </label>
            <label class="payment-option">
                <input type="radio" name="pagamento" value="CARTAO">
                <div class="payment-card">üí≥ Cart√£o</div>
            </label>
            <label class="payment-option">
                <input type="radio" name="pagamento" value="DINHEIRO">
                <div class="payment-card">üíµ Dinheiro</div>
            </label>
        </div>
    </div>

    <div class="total-bar">Total: R$ <span id="total-value">0.00</span></div>

    <button class="btn-checkout" onclick="finalizarPedido()">Concluir Pedido ‚úÖ</button>
    <a href="/" class="back-link">‚Üê Continuar Comprando</a>
</div>

<script>
    // Carrega carrinho do LocalStorage
    let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];

    // Renderiza Itens
    function renderCart() {
        const container = document.getElementById('cart-items');
        let total = 0;
        container.innerHTML = '';

        if (carrinho.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#888;">Seu carrinho est√° vazio.</p>';
            document.getElementById('total-value').innerText = '0.00';
            return;
        }

        carrinho.forEach((item, index) => {
            const subtotal = item.preco * item.quantidade;
            total += subtotal;
            container.innerHTML += `
                <div class="cart-item">
                    <div>
                        <strong>${item.nome}</strong><br>
                        <small>R$ ${item.preco} un.</small>
                    </div>
                    <div class="qty-controls">
                        <button onclick="alterarQtd(${index}, -1)">-</button>
                        <span>${item.quantidade}</span>
                        <button onclick="alterarQtd(${index}, 1)">+</button>
                    </div>
                    <div>R$ ${subtotal.toFixed(2)}</div>
                </div>
            `;
        });
        document.getElementById('total-value').innerText = total.toFixed(2);
    }

    function alterarQtd(index, delta) {
        carrinho[index].quantidade += delta;
        if (carrinho[index].quantidade <= 0) carrinho.splice(index, 1);
        localStorage.setItem('carrinho', JSON.stringify(carrinho));
        renderCart();
    }

    // Carrega Endere√ßos do Usu√°rio
    async function carregarEnderecos() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '/login';

        try {
            const res = await fetch('/enderecos', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const enderecos = await res.json();
            const select = document.getElementById('endereco-select');
            
            if (enderecos.length === 0) {
                select.innerHTML = '<option value="">Cadastre um endere√ßo acima üëÜ</option>';
            } else {
                select.innerHTML = '<option value="" disabled selected>Selecione o local de entrega</option>';
                enderecos.forEach(end => {
                    const opt = document.createElement('option');
                    opt.value = end.id;
                    opt.textContent = `${end.rua}, ${end.numero} - ${end.bairro} (${end.cidade})`;
                    select.appendChild(opt);
                });
            }
        } catch (err) { console.error(err); }
    }

    // Finalizar Pedido
    async function finalizarPedido() {
        const token = localStorage.getItem('token');
        const enderecoId = document.getElementById('endereco-select').value;
        const total = document.getElementById('total-value').innerText;
        
        // Pega o radio button selecionado
        const pagamentoEl = document.querySelector('input[name="pagamento"]:checked');
        const metodoPagamento = pagamentoEl ? pagamentoEl.value : null;

        if (carrinho.length === 0) return alert('Carrinho vazio!');
        if (!enderecoId) return alert('Selecione um endere√ßo!');
        if (!metodoPagamento) return alert('Selecione uma forma de pagamento!');

        const payload = {
            itens: carrinho.map(i => ({ 
                produtoId: i.id, // ID do produto precisa vir do index
                quantidade: i.quantidade, 
                precoUnit: i.preco 
            })),
            total: total,
            enderecoId: enderecoId,
            metodoPagamento: metodoPagamento
        };

        try {
            const res = await fetch('/pedidos', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('Pedido realizado com sucesso! üéâ');
                localStorage.removeItem('carrinho');
                window.location.href = '/';
            } else {
                const data = await res.json();
                alert(data.error || 'Erro ao processar pedido.');
            }
        } catch (err) { alert('Erro de conex√£o.'); }
    }

    renderCart();
    carregarEnderecos();
</script>

</body>
</html>